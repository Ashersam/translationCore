<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>actions/CSVExportActions.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="CreativeCommonsPage.html">CreativeCommonsPage</a></li><li><a href="Door43Login.html">Door43Login</a></li><li><a href="GroupItem.html">GroupItem</a></li><li><a href="HomeContainerContentWrapper.html">HomeContainerContentWrapper</a></li><li><a href="InstructionsCard.html">InstructionsCard</a></li><li><a href="LocalLogin.html">LocalLogin</a></li><li><a href="Login.html">Login</a></li><li><a href="module.html#.exports">exports</a></li><li><a href="Profile.html">Profile</a></li><li><a href="ProjectValidationContentWrapper.html">ProjectValidationContentWrapper</a></li><li><a href="StatementOfFaithPage.html">StatementOfFaithPage</a></li><li><a href="TermsAndConditionsPage.html">TermsAndConditionsPage</a></li></ul><h3>Modules</h3><ul><li><a href="module-Actions_AlertModal.html">Actions/AlertModal</a><ul class='methods'><li data-type='method'><a href="module-Actions_AlertModal.html#.closeAlertDialog">closeAlertDialog</a></li><li data-type='method'><a href="module-Actions_AlertModal.html#.openAlertDialog">openAlertDialog</a></li><li data-type='method'><a href="module-Actions_AlertModal.html#.openOptionDialog">openOptionDialog</a></li></ul></li><li><a href="module-Actions_BodyUI.html">Actions/BodyUI</a><ul class='methods'><li data-type='method'><a href="module-Actions_BodyUI.html#.dimScreen">dimScreen</a></li></ul></li><li><a href="module-Actions_CheckDataLoad.html">Actions/CheckDataLoad</a><ul class='methods'><li data-type='method'><a href="module-Actions_CheckDataLoad.html#.generateLoadPath">generateLoadPath</a></li><li data-type='method'><a href="module-Actions_CheckDataLoad.html#.loadCheckData">loadCheckData</a></li><li data-type='method'><a href="module-Actions_CheckDataLoad.html#.loadComments">loadComments</a></li><li data-type='method'><a href="module-Actions_CheckDataLoad.html#.loadReminders">loadReminders</a></li><li data-type='method'><a href="module-Actions_CheckDataLoad.html#.loadSelections">loadSelections</a></li><li data-type='method'><a href="module-Actions_CheckDataLoad.html#.loadVerseEdit">loadVerseEdit</a></li></ul></li><li><a href="module-Actions_Comments.html">Actions/Comments</a></li><li><a href="module-Actions_ContextId.html">Actions/ContextId</a><ul class='methods'><li data-type='method'><a href="module-Actions_ContextId.html#.loadCurrentContextId">loadCurrentContextId</a></li><li data-type='method'><a href="module-Actions_ContextId.html#~firstContextId">firstContextId</a></li><li data-type='method'><a href="module-Actions_ContextId.html#~lastContextId">lastContextId</a></li></ul></li><li><a href="module-Actions_CopyrightCheck.html">Actions/CopyrightCheck</a><ul class='methods'><li data-type='method'><a href="module-Actions_CopyrightCheck.html#.selectProjectLicense">selectProjectLicense</a></li></ul></li><li><a href="module-Actions_CSVExport.html">Actions/CSVExport</a><ul class='methods'><li data-type='method'><a href="module-Actions_CSVExport.html#.exportToCSV">exportToCSV</a></li><li data-type='method'><a href="module-Actions_CSVExport.html#.loadGroupsData">loadGroupsData</a></li></ul></li><li><a href="module-Actions_GroupMenu.html">Actions/GroupMenu</a></li><li><a href="module-Actions_GroupsData.html">Actions/GroupsData</a><ul class='methods'><li data-type='method'><a href="module-Actions_GroupsData.html#.verifyGroupDataMatchesWithFs">verifyGroupDataMatchesWithFs</a></li><li data-type='method'><a href="module-Actions_GroupsData.html#~contains">contains</a></li><li data-type='method'><a href="module-Actions_GroupsData.html#~filterAndSort">filterAndSort</a></li><li data-type='method'><a href="module-Actions_GroupsData.html#~generatePathToDataItems">generatePathToDataItems</a></li><li data-type='method'><a href="module-Actions_GroupsData.html#~getUniqueObjectsFromFolder">getUniqueObjectsFromFolder</a></li><li data-type='method'><a href="module-Actions_GroupsData.html#~toggleGroupDataItems">toggleGroupDataItems</a></li></ul></li><li><a href="module-Actions_GroupsIndex.html">Actions/GroupsIndex</a></li><li><a href="module-LoaderActions.html">LoaderActions</a><ul class='methods'><li data-type='method'><a href="module-LoaderActions.html#.sendProgressForKey">sendProgressForKey</a></li></ul></li><li><a href="module-LocaleActions.html">LocaleActions</a><ul class='methods'><li data-type='method'><a href="module-LocaleActions.html#~enhanceTranslation">enhanceTranslation</a></li><li data-type='method'><a href="module-LocaleActions.html#~explodeLocaleName">explodeLocaleName</a></li><li data-type='method'><a href="module-LocaleActions.html#~onMissingTranslation">onMissingTranslation</a></li><li data-type='method'><a href="module-LocaleActions.html#~setActiveLanguageSafely">setActiveLanguageSafely</a></li><li data-type='method'><a href="module-LocaleActions.html#~setSystemLocale">setSystemLocale</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#add">add</a></li><li><a href="global.html#addNewBible">addNewBible</a></li><li><a href="global.html#addObjectPropertyToManifest">addObjectPropertyToManifest</a></li><li><a href="global.html#addProjectValidationStep">addProjectValidationStep</a></li><li><a href="global.html#addVerseEdit">addVerseEdit</a></li><li><a href="global.html#addWordBankItemToWordBank">addWordBankItemToWordBank</a></li><li><a href="global.html#alignmentsFromTargetLanguageVerse">alignmentsFromTargetLanguageVerse</a></li><li><a href="global.html#archiveSourceFiles">archiveSourceFiles</a></li><li><a href="global.html#Books">Books</a></li><li><a href="global.html#calculateProgress">calculateProgress</a></li><li><a href="global.html#cancelAndCloseProjectInformationCheck">cancelAndCloseProjectInformationCheck</a></li><li><a href="global.html#changeSelections">changeSelections</a></li><li><a href="global.html#chapterGroupsData">chapterGroupsData</a></li><li><a href="global.html#chapterGroupsIndex">chapterGroupsIndex</a></li><li><a href="global.html#checkBookReference">checkBookReference</a></li><li><a href="global.html#checkCheckers">checkCheckers</a></li><li><a href="global.html#checkIfValidBetaProject">checkIfValidBetaProject</a></li><li><a href="global.html#checkLanguageDetails">checkLanguageDetails</a></li><li><a href="global.html#checkSelectionOccurrences">checkSelectionOccurrences</a></li><li><a href="global.html#checkTranslators">checkTranslators</a></li><li><a href="global.html#checkUSFMForMergeConflicts">checkUSFMForMergeConflicts</a></li><li><a href="global.html#cleanupTmpPath">cleanupTmpPath</a></li><li><a href="global.html#clearLastProject">clearLastProject</a></li><li><a href="global.html#clearProjectInformationReducer">clearProjectInformationReducer</a></li><li><a href="global.html#clone">clone</a></li><li><a href="global.html#combineData">combineData</a></li><li><a href="global.html#combineGreekVerse">combineGreekVerse</a></li><li><a href="global.html#commit">commit</a></li><li><a href="global.html#confirmContinueOrCancelImportValidation">confirmContinueOrCancelImportValidation</a></li><li><a href="global.html#convertGitErrorMessage">convertGitErrorMessage</a></li><li><a href="global.html#convertToFullBookName">convertToFullBookName</a></li><li><a href="global.html#convertToProjectFormat">convertToProjectFormat</a></li><li><a href="global.html#createCheckArray">createCheckArray</a></li><li><a href="global.html#createRepo">createRepo</a></li><li><a href="global.html#createUSFMFromTsProject">createUSFMFromTsProject</a></li><li><a href="global.html#dateFromTimestamp">dateFromTimestamp</a></li><li><a href="global.html#deleteImportProjectForLink">deleteImportProjectForLink</a></li><li><a href="global.html#deleteProjectFromImportsFolder">deleteProjectFromImportsFolder</a></li><li><a href="global.html#detectInvalidProjectStructure">detectInvalidProjectStructure</a></li><li><a href="global.html#displayLoadingUSFMAlert">displayLoadingUSFMAlert</a></li><li><a href="global.html#displayTools">displayTools</a></li><li><a href="global.html#download">download</a></li><li><a href="global.html#editTargetVerseInBiblesReducer">editTargetVerseInBiblesReducer</a></li><li><a href="global.html#exportToUSFM">exportToUSFM</a></li><li><a href="global.html#extractWords">extractWords</a></li><li><a href="global.html#finalize">finalize</a></li><li><a href="global.html#findMissingVerses">findMissingVerses</a></li><li><a href="global.html#fixManifestVerThree">fixManifestVerThree</a></li><li><a href="global.html#flattenContextId">flattenContextId</a></li><li><a href="global.html#generateBlankAlignments">generateBlankAlignments</a></li><li><a href="global.html#generateCSVFile">generateCSVFile</a></li><li><a href="global.html#generateCSVString">generateCSVString</a></li><li><a href="global.html#generateManifest">generateManifest</a></li><li><a href="global.html#generateManifestForUsfmProject">generateManifestForUsfmProject</a></li><li><a href="global.html#generateSavePath">generateSavePath</a></li><li><a href="global.html#generateTartgetLanguageManifest">generateTartgetLanguageManifest</a></li><li><a href="global.html#generateTimestamp">generateTimestamp</a></li><li><a href="global.html#generateWordBank">generateWordBank</a></li><li><a href="global.html#getActiveLanguage">getActiveLanguage</a></li><li><a href="global.html#getActiveLocaleLanguage">getActiveLocaleLanguage</a></li><li><a href="global.html#getAnchorTags">getAnchorTags</a></li><li><a href="global.html#getApplicationVersion">getApplicationVersion</a></li><li><a href="global.html#getArchBits">getArchBits</a></li><li><a href="global.html#getBaseName">getBaseName</a></li><li><a href="global.html#getBibleFromStaticPackage">getBibleFromStaticPackage</a></li><li><a href="global.html#getBibleIndex">getBibleIndex</a></li><li><a href="global.html#getBibleManifest">getBibleManifest</a></li><li><a href="global.html#getChapterFromVerseText">getChapterFromVerseText</a></li><li><a href="global.html#getCurrentManifestVersion">getCurrentManifestVersion</a></li><li><a href="global.html#getErrorMessage">getErrorMessage</a></li><li><a href="global.html#getExpectedBookVerses">getExpectedBookVerses</a></li><li><a href="global.html#getFilePath">getFilePath</a></li><li><a href="global.html#getGroupName">getGroupName</a></li><li><a href="global.html#getGroupsData">getGroupsData</a></li><li><a href="global.html#getGroupsIndex">getGroupsIndex</a></li><li><a href="global.html#getLanguageByCode">getLanguageByCode</a></li><li><a href="global.html#getLanguageByCodeSelection">getLanguageByCodeSelection</a></li><li><a href="global.html#getLanguageByName">getLanguageByName</a></li><li><a href="global.html#getLanguageByNameSelection">getLanguageByNameSelection</a></li><li><a href="global.html#getLanguageCodes">getLanguageCodes</a></li><li><a href="global.html#getLanguages">getLanguages</a></li><li><a href="global.html#getLanguagesSortedByCode">getLanguagesSortedByCode</a></li><li><a href="global.html#getLanguagesSortedByName">getLanguagesSortedByName</a></li><li><a href="global.html#getLexiconsFromStaticPackage">getLexiconsFromStaticPackage</a></li><li><a href="global.html#getLocaleLanguages">getLocaleLanguages</a></li><li><a href="global.html#getLocaleLoaded">getLocaleLoaded</a></li><li><a href="global.html#getLocaleSettingsOpen">getLocaleSettingsOpen</a></li><li><a href="global.html#getManifestPath">getManifestPath</a></li><li><a href="global.html#getMergeConflicts">getMergeConflicts</a></li><li><a href="global.html#getMissingVerses">getMissingVerses</a></li><li><a href="global.html#getMyProjects">getMyProjects</a></li><li><a href="global.html#getOccurrenceInString">getOccurrenceInString</a></li><li><a href="global.html#getParsedUSFM">getParsedUSFM</a></li><li><a href="global.html#getProjectDirectories">getProjectDirectories</a></li><li><a href="global.html#getProjectId">getProjectId</a></li><li><a href="global.html#getProjectManifest">getProjectManifest</a></li><li><a href="global.html#getProjectName">getProjectName</a></li><li><a href="global.html#getProjectsFromFolder">getProjectsFromFolder</a></li><li><a href="global.html#getQuoteOccurrencesInVerse">getQuoteOccurrencesInVerse</a></li><li><a href="global.html#getResourcesFromStaticPackage">getResourcesFromStaticPackage</a></li><li><a href="global.html#getSetting">getSetting</a></li><li><a href="global.html#getTHelpsFromStaticPackage">getTHelpsFromStaticPackage</a></li><li><a href="global.html#getToggledGroupData">getToggledGroupData</a></li><li><a href="global.html#getToolFolderNames">getToolFolderNames</a></li><li><a href="global.html#getToolProgress">getToolProgress</a></li><li><a href="global.html#getUniqueBookIds">getUniqueBookIds</a></li><li><a href="global.html#getUSFMDetails">getUSFMDetails</a></li><li><a href="global.html#getUSFMIdTag">getUSFMIdTag</a></li><li><a href="global.html#getValidGitUrl">getValidGitUrl</a></li><li><a href="global.html#getVersionFromManifest">getVersionFromManifest</a></li><li><a href="global.html#getWordText">getWordText</a></li><li><a href="global.html#groupName">groupName</a></li><li><a href="global.html#init">init</a></li><li><a href="global.html#initiateProjectValidationStepper">initiateProjectValidationStepper</a></li><li><a href="global.html#isGitInstalled">isGitInstalled</a></li><li><a href="global.html#isLanguageCodeValid">isLanguageCodeValid</a></li><li><a href="global.html#isOldTestament">isOldTestament</a></li><li><a href="global.html#isProjectMissingVerses">isProjectMissingVerses</a></li><li><a href="global.html#isUSFMProject">isUSFMProject</a></li><li><a href="global.html#launchButton">launchButton</a></li><li><a href="global.html#loadAlignmentData">loadAlignmentData</a></li><li><a href="global.html#loadAllGroupsData">loadAllGroupsData</a></li><li><a href="global.html#loadBiblesChapter">loadBiblesChapter</a></li><li><a href="global.html#loadFile">loadFile</a></li><li><a href="global.html#loadGroupData">loadGroupData</a></li><li><a href="global.html#loadLexiconEntry">loadLexiconEntry</a></li><li><a href="global.html#loadProjectData">loadProjectData</a></li><li><a href="global.html#loadProjectDetails">loadProjectDetails</a></li><li><a href="global.html#loadProjectLicenseMarkdownFile">loadProjectLicenseMarkdownFile</a></li><li><a href="global.html#loadResourceArticle">loadResourceArticle</a></li><li><a href="global.html#loadState">loadState</a></li><li><a href="global.html#loadTargetLanguageChapter">loadTargetLanguageChapter</a></li><li><a href="global.html#loadUSFMFile">loadUSFMFile</a></li><li><a href="global.html#localImport">localImport</a></li><li><a href="global.html#login">login</a></li><li><a href="global.html#manifestExists">manifestExists</a></li><li><a href="global.html#merge">merge</a></li><li><a href="global.html#migrate">migrate</a></li><li><a href="global.html#migrateToolsSettings">migrateToolsSettings</a></li><li><a href="global.html#migrateValidateLoadProject">migrateValidateLoadProject</a></li><li><a href="global.html#mirror">mirror</a></li><li><a href="global.html#move">move</a></li><li><a href="global.html#moveBackToWordBank">moveBackToWordBank</a></li><li><a href="global.html#moveTopWordItemToAlignment">moveTopWordItemToAlignment</a></li><li><a href="global.html#moveWordBankItemToAlignment">moveWordBankItemToAlignment</a></li><li><a href="global.html#occurrences">occurrences</a></li><li><a href="global.html#occurrencesInString">occurrencesInString</a></li><li><a href="global.html#onlineImport">onlineImport</a></li><li><a href="global.html#openOnlyProjectDetailsScreen">openOnlyProjectDetailsScreen</a></li><li><a href="global.html#pad">pad</a></li><li><a href="global.html#parseMergeConflictVersion">parseMergeConflictVersion</a></li><li><a href="global.html#populateEmptyChapterAlignmentData">populateEmptyChapterAlignmentData</a></li><li><a href="global.html#projectHasMergeConflicts">projectHasMergeConflicts</a></li><li><a href="global.html#projectHasMultipleBooks">projectHasMultipleBooks</a></li><li><a href="global.html#promptMissingDetails">promptMissingDetails</a></li><li><a href="global.html#pull">pull</a></li><li><a href="global.html#push">push</a></li><li><a href="global.html#read">read</a></li><li><a href="global.html#removeProjectValidationStep">removeProjectValidationStep</a></li><li><a href="global.html#removeWordBankItemFromWordBank">removeWordBankItemFromWordBank</a></li><li><a href="global.html#run">run</a></li><li><a href="global.html#runGitCommand">runGitCommand</a></li><li><a href="global.html#save">save</a></li><li><a href="global.html#saveAlignmentData">saveAlignmentData</a></li><li><a href="global.html#saveAndCloseProjectInformationCheck">saveAndCloseProjectInformationCheck</a></li><li><a href="global.html#saveComments">saveComments</a></li><li><a href="global.html#saveContextId">saveContextId</a></li><li><a href="global.html#saveData">saveData</a></li><li><a href="global.html#saveGroupsData">saveGroupsData</a></li><li><a href="global.html#saveGroupsIndex">saveGroupsIndex</a></li><li><a href="global.html#saveProjectLicense">saveProjectLicense</a></li><li><a href="global.html#saveProjectManifest">saveProjectManifest</a></li><li><a href="global.html#saveReminders">saveReminders</a></li><li><a href="global.html#saveSelections">saveSelections</a></li><li><a href="global.html#saveState">saveState</a></li><li><a href="global.html#saveTargetBible">saveTargetBible</a></li><li><a href="global.html#saveTargetLanguage">saveTargetLanguage</a></li><li><a href="global.html#saveToolViews">saveToolViews</a></li><li><a href="global.html#saveVerseEdit">saveVerseEdit</a></li><li><a href="global.html#selectLanguage">selectLanguage</a></li><li><a href="global.html#selectLocalProject">selectLocalProject</a></li><li><a href="global.html#selectTool">selectTool</a></li><li><a href="global.html#setBookIDInProjectInformationReducer">setBookIDInProjectInformationReducer</a></li><li><a href="global.html#setCheckersInProjectInformationReducer">setCheckersInProjectInformationReducer</a></li><li><a href="global.html#setContributorsInProjectInformationReducer">setContributorsInProjectInformationReducer</a></li><li><a href="global.html#setLanguageDirectionInProjectInformationReducer">setLanguageDirectionInProjectInformationReducer</a></li><li><a href="global.html#setLanguageIdInProjectInformationReducer">setLanguageIdInProjectInformationReducer</a></li><li><a href="global.html#setLanguageNameInProjectInformationReducer">setLanguageNameInProjectInformationReducer</a></li><li><a href="global.html#setProjectManifest">setProjectManifest</a></li><li><a href="global.html#setSaveLocation">setSaveLocation</a></li><li><a href="global.html#setSetting">setSetting</a></li><li><a href="global.html#SETTINGS_DIRECTORY">SETTINGS_DIRECTORY</a></li><li><a href="global.html#setToolSettings">setToolSettings</a></li><li><a href="global.html#setUpDefaultUSFMManifest">setUpDefaultUSFMManifest</a></li><li><a href="global.html#setUpManifest">setUpManifest</a></li><li><a href="global.html#setUpProjectDetails">setUpProjectDetails</a></li><li><a href="global.html#setUpUSFMJSONObject">setUpUSFMJSONObject</a></li><li><a href="global.html#setVersionInManifest">setVersionInManifest</a></li><li><a href="global.html#shouldRun">shouldRun</a></li><li><a href="global.html#showElectronGitDialog">showElectronGitDialog</a></li><li><a href="global.html#showElectronGitSetup">showElectronGitSetup</a></li><li><a href="global.html#sortByNamesCaseInsensitive">sortByNamesCaseInsensitive</a></li><li><a href="global.html#sortGroupsIndex">sortGroupsIndex</a></li><li><a href="global.html#sortWordObjectsByString">sortWordObjectsByString</a></li><li><a href="global.html#status">status</a></li><li><a href="global.html#targetLanguageVerseFromAlignments">targetLanguageVerseFromAlignments</a></li><li><a href="global.html#testResourceByType">testResourceByType</a></li><li><a href="global.html#tHelpsPath">tHelpsPath</a></li><li><a href="global.html#timeFromTimestamp">timeFromTimestamp</a></li><li><a href="global.html#toggleNextButton">toggleNextButton</a></li><li><a href="global.html#toggleProjectInformationCheckSaveButton">toggleProjectInformationCheckSaveButton</a></li><li><a href="global.html#toggleReminder">toggleReminder</a></li><li><a href="global.html#toggleSetting">toggleSetting</a></li><li><a href="global.html#tokenize">tokenize</a></li><li><a href="global.html#TruncateAcronym">TruncateAcronym</a></li><li><a href="global.html#update">update</a></li><li><a href="global.html#updateAlignmentData">updateAlignmentData</a></li><li><a href="global.html#updateCheckerName">updateCheckerName</a></li><li><a href="global.html#updateContributorName">updateContributorName</a></li><li><a href="global.html#updateLanguage">updateLanguage</a></li><li><a href="global.html#updateMergeConflictNextButton">updateMergeConflictNextButton</a></li><li><a href="global.html#updateProjectFolderToNameSpecification">updateProjectFolderToNameSpecification</a></li><li><a href="global.html#updateStepperIndex">updateStepperIndex</a></li><li><a href="global.html#updateVersionSelection">updateVersionSelection</a></li><li><a href="global.html#uploadProject">uploadProject</a></li><li><a href="global.html#userTimestampObject">userTimestampObject</a></li><li><a href="global.html#validate">validate</a></li><li><a href="global.html#validateContextIdQuote">validateContextIdQuote</a></li><li><a href="global.html#validateProject">validateProject</a></li><li><a href="global.html#validateSelections">validateSelections</a></li><li><a href="global.html#verifyAllRequiredFieldsAreCompleted">verifyAllRequiredFieldsAreCompleted</a></li><li><a href="global.html#verifyChunks">verifyChunks</a></li><li><a href="global.html#verifyProjectType">verifyProjectType</a></li><li><a href="global.html#withLocale">withLocale</a></li><li><a href="global.html#wordObjectArrayFromString">wordObjectArrayFromString</a></li><li><a href="global.html#writeUSFM">writeUSFM</a></li><li><a href="global.html#writeUSFMJSONToFS">writeUSFMJSONToFS</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">actions/CSVExportActions.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @module Actions/CSVExport
 */

import consts from './ActionTypes';
import fs from 'fs-extra';
import path from 'path-extra';
import ospath from 'ospath';
import zipFolder from 'zip-folder';
import { ipcRenderer } from 'electron';
// actions
import * as AlertModalActions from './AlertModalActions';
import * as BodyUIActions from './BodyUIActions';
import * as MergeConflictActions from '../actions/MergeConflictActions';
import * as ProjectImportStepperActions from '../actions/ProjectImportStepperActions';
// helpers
import * as csvHelpers from '../helpers/csvHelpers';
import * as LoadHelpers from '../helpers/LoadHelpers';

/**
 * @description - Wrapper function to handle exporting to CSV
 * @param {string} projectPath - Path to current project
 */
export function exportToCSV(projectPath) {
  return ((dispatch, getState) => {
    let manifest = LoadHelpers.loadFile(projectPath, 'manifest.json');
    dispatch(MergeConflictActions.validate(projectPath, manifest));
    const { conflicts } = getState().mergeConflictReducer;
    if (conflicts) {
      dispatch(ProjectImportStepperActions.cancelProjectValidationStepper());
      return dispatch(AlertModalActions.openAlertDialog(
        `This project has merge conflicts and cannot be exported. Select the project to resolve merge conflicts, then try again.`));
    }
    dispatch(BodyUIActions.dimScreen(true));
    setTimeout(() => {
      // generate default paths
      const csvSaveLocation = getState().settingsReducer.csvSaveLocation;
      const projectName = projectPath.split(path.sep).pop();
      let defaultPath = getDefaultPath(csvSaveLocation, projectName);
      // prompt user for save location
      const filters = [{ name: 'Zip Files', extensions: ['zip'] }];
      const title = 'Save CSV Export As';
      const options = { defaultPath: defaultPath, filters: filters, title: title };
      let filePath = ipcRenderer.sendSync('save-as', { options: options });
      if (!filePath) {
        dispatch(BodyUIActions.dimScreen(false));
        dispatch(AlertModalActions.openAlertDialog('Export Cancelled', false));
        return;
      } else {
        dispatch({
          type: consts.SET_CSV_SAVE_LOCATION,
          csvSaveLocation: filePath.split(projectName)[0]
        });
      }
      dispatch(BodyUIActions.dimScreen(false));
      // show loading dialog
      let message = "Exporting " + projectName + " Please wait...";
      dispatch(AlertModalActions.openAlertDialog(message, true));
      // export the csv and zip it
      exportToCSVZip(projectPath, filePath)
        .then(() => {
          message = projectName + " has been successfully exported.";
          dispatch(AlertModalActions.openAlertDialog(message, false));
        })
        .catch((err) => {
          message = "Export failed: " + err;
          dispatch(AlertModalActions.openAlertDialog(message, false));
        });
    }, 200);
  });
}
/**
 * @description - Get the default path for the OS
 * @param {string} csvSaveLocation - Path to CSV location
 * @param {string} projectName - Name of the current project
 */
export const getDefaultPath = (csvSaveLocation, projectName) => {
  let defaultPath;
  const OSX_DOCUMENTS_PATH = path.join(ospath.home(), 'Documents');
  const WIN_DOCUMENTS_PATH = path.join(ospath.home(), 'My Documents');
  if (csvSaveLocation) {
    defaultPath = path.join(csvSaveLocation, projectName + '.zip');
  }
  else if (fs.existsSync(OSX_DOCUMENTS_PATH)) {
    defaultPath = path.join(OSX_DOCUMENTS_PATH, projectName + '.zip');
  } else if (fs.existsSync(WIN_DOCUMENTS_PATH)) {
    defaultPath = path.join(WIN_DOCUMENTS_PATH, projectName + '.zip');
  }
  else {
    defaultPath = path.join(ospath.home(), projectName + '.zip');
  }
  return defaultPath;
};
/**
 * @description - Chain of saving csv data then zipping it up and saving
 * @param {string} projectPath - Path to current project
 * @param {string} filePath - Path to save the zip file
 */
export const exportToCSVZip = (projectPath, filePath) => {
  return new Promise((resolve, reject) => {
    Promise.resolve(true)
      .then(() => saveAllCSVData(projectPath))
      .then(() => zipCSVData(projectPath, filePath))
      .then(() => {
        csvHelpers.cleanupTmpPath(projectPath);
        resolve(true);
      })
      .catch((err) => {
        csvHelpers.cleanupTmpPath(projectPath);
        reject(err);
      });
  });
};
/**
 * @description - Zip all of the csv files and save ot filePath
 * @param {string} projectPath - path of the project
 * @param {string} filePath - Path to save the zip file
 */
export const zipCSVData = (projectPath, filePath) => {
  return new Promise((resolve, reject) => {
    const _tmpPath = csvHelpers.tmpPath(projectPath);
    zipFolder(_tmpPath, filePath, (err) => {
      if (err) {
        reject("Could not create zip file.");
      } else {
        resolve(true);
      }
    });
  });
};
/**
 * @description - Chain of saving all csv data
 * @param {string} projectPath - Path to current project
 */
export const saveAllCSVData = (projectPath) => {
  return new Promise((resolve, reject) => {
    const toolNames = csvHelpers.getToolFolderNames(projectPath);
    if (!toolNames || !toolNames.length) {
      throw 'No tools have loaded for this project.';
    }
    let iterablePromises = [];
    toolNames.forEach((toolName) => {
      const p = new Promise((_resolve) => {
        return saveToolDataToCSV(toolName, projectPath)
          .then(_resolve);
      });
      iterablePromises.push(p);
    });
    Promise.all(iterablePromises)
      .then(() => saveVerseEditsToCSV(projectPath))
      .then(() => saveRemindersToCSV(projectPath))
      .then(() => saveCommentsToCSV(projectPath))
      .then(() => saveSelectionsToCSV(projectPath))
      .then(resolve)
      .catch(reject);
  });
};
/**
 * @ description - Saves teh Tool data to csv
 * @param {string} toolName - current tool name
 * @param {string} projectPath - path of the project
 */
export const saveToolDataToCSV = (toolName, projectPath) => {
  return new Promise((resolve, reject) => {
    loadGroupsData(toolName, projectPath)
      .then((object) => saveGroupsToCSV(object, toolName, projectPath))
      .then(() => {
        resolve(true);
      })
      .catch(err => {
        const message = "Problem saving data for tool: " + toolName + "\n Error:" + err;
        reject(message);
      });
  });
};

/**
 * @description - Loads the Groups Data for a tool
 * @param {string} toolName - name of the tool being saved i.e. translationNotes
 * @param {string} projectPath - path of the project
 */
export function loadGroupsData(toolName, projectPath) {
  return new Promise((resolve) => {
    const dataPath = csvHelpers.dataPath(projectPath);
    const projectId = csvHelpers.getProjectId(projectPath);
    const groupsDataFolderPath = path.join(dataPath, 'index', toolName, projectId);
    if (fs.existsSync(groupsDataFolderPath)) {
      const groupDataFiles = fs.readdirSync(groupsDataFolderPath)
        .filter(file => { return path.extname(file) == '.json' });
      var groupsData = {};
      groupDataFiles.forEach(groupDataFile => {
        const groupId = groupDataFile.split('.')[0];
        const groupDataPath = path.join(groupsDataFolderPath, groupDataFile);
        const groupData = fs.readJsonSync(groupDataPath);
        groupsData[groupId] = groupData;
      });
      resolve(groupsData);
    } else {
      const err = 'Group Data path does not exist: ' + groupsDataFolderPath;
      console.warn(err);
      // In case of Autographa or testing tools, just move on...
      resolve(true);
    }
  });
}
/**
 * @description - Creates csv from object and saves it.
 * @param {object} obj - object to save to the filesystem
 * @param {string} projectPath - path of the project
 * @param {string} toolName - name of the tool being saved i.e. translationNotes
 */
export const saveGroupsToCSV = (obj, toolName, projectPath) => {
  return new Promise((resolve, reject) => {
    let objectArray = [];
    const groupNames = Object.keys(obj);
    groupNames.forEach(groupName => {
      obj[groupName].forEach(groupData => {
        const object = groupData;
        const data = { priority: object.priority };
        const flatContextId = csvHelpers.flattenContextId(object.contextId);
        const newObject = Object.assign({}, data, flatContextId);
        objectArray.push(newObject);
      });
    });
    const dataPath = csvHelpers.dataPath(projectPath);
    const filePath = path.join(dataPath, 'output', toolName + '_CheckInformation.csv');
    csvHelpers.generateCSVFile(objectArray, filePath)
      .then(() => {
        return resolve(true);
      })
      .catch((err) => {
        console.log('saveGroupsToCSV: ', err);
        reject(err);
      });
  });
};
/**
 * @description - Creates csv from object and saves it.
* @param {string} projectPath - path of the project
 */
export const saveVerseEditsToCSV = (projectPath) => {
  return new Promise((resolve, reject) => {
    loadProjectDataByType(projectPath, 'verseEdits')
      .then((array) => {
        const objectArray = array.map(data => {
          const _data = {
            after: data.verseAfter,
            before: data.verseBefore,
            tags: data.tags
          };
          return csvHelpers.combineData(_data, data.contextId, data.userName, data.modifiedTimestamp);
        });
        const dataPath = csvHelpers.dataPath(projectPath);
        const filePath = path.join(dataPath, 'output', 'VerseEdits.csv');
        csvHelpers.generateCSVFile(objectArray, filePath).then(() => {
          resolve(true);
        });
      })
      .catch(reject);
  });
};
/**
 * @description - Creates csv from object and saves it.
* @param {string} projectPath - path of the project
 */
export const saveCommentsToCSV = (projectPath) => {
  return new Promise((resolve) => {
    loadProjectDataByType(projectPath, 'comments')
      .then((array) => {
        const objectArray = array.map(data => {
          const _data = { text: data.text };
          return csvHelpers.combineData(_data, data.contextId, data.userName, data.modifiedTimestamp);
        });
        const dataPath = csvHelpers.dataPath(projectPath);
        const filePath = path.join(dataPath, 'output', 'Comments.csv');
        csvHelpers.generateCSVFile(objectArray, filePath)
          .then(resolve);
      });
  });
};
/**
 * @description - Creates csv from object and saves it.
* @param {string} projectPath - path of the project
 */
export const saveSelectionsToCSV = (projectPath) => {
  return new Promise((resolve, reject) => {
    loadProjectDataByType(projectPath, 'selections')
      .then((array) => {
        const objectArray = [];
        array.forEach(data => {
          data.selections.forEach(selection => {
            const _data = {
              text: selection.text,
              "selection/occurrence": selection.occurrence,
              "selection/occurrences": selection.occurrences
            };
            const newObject = csvHelpers.combineData(_data, data.contextId, data.userName, data.modifiedTimestamp);
            objectArray.push(newObject);
          });
        });
        const dataPath = csvHelpers.dataPath(projectPath);
        const filePath = path.join(dataPath, 'output', 'Selections.csv');
        csvHelpers.generateCSVFile(objectArray, filePath).then(() => {
          resolve(true);
        });
      })
      .catch(reject);
  });
};
/**
 * @description - Creates csv from object and saves it.
 * @param {string} projectPath - path of the project
 */
export const saveRemindersToCSV = (projectPath) => {
  return new Promise((resolve, reject) => {
    loadProjectDataByType(projectPath, 'reminders')
      .then((array) => {
        const objectArray = array.map(data => {
          const _data = { enabled: data.enabled };
          return csvHelpers.combineData(_data, data.contextId, data.userName, data.modifiedTimestamp);
        });
        const dataPath = csvHelpers.dataPath(projectPath);
        const filePath = path.join(dataPath, 'output', 'Reminders.csv');
        csvHelpers.generateCSVFile(objectArray, filePath).then(() => {
          resolve(true);
        });
      })
      .catch(reject);
  });
};

export function loadProjectDataByType(projectPath, type) {
  return new Promise((resolve, reject) => {
    let checkDataArray = [];
    const dataPath = csvHelpers.dataPath(projectPath);
    const projectId = csvHelpers.getProjectId(projectPath);
    const chaptersPath = path.join(dataPath, 'checkData', type, projectId);
    if (fs.existsSync(chaptersPath)) {
      const chapters = fs.readdirSync(chaptersPath)
        .filter(file => { return fs.lstatSync(path.join(chaptersPath, file)).isDirectory() });
      chapters.forEach(chapter => {
        if (!parseInt(chapter)) return;
        const chapterPath = path.join(chaptersPath, chapter);
        const verses = fs.readdirSync(chapterPath)
          .filter(file => { return fs.lstatSync(path.join(chapterPath, file)).isDirectory() });
        verses.forEach(verse => {
          if (!parseInt(verse)) return;
          const versePath = path.join(chapterPath, verse);
          const dataFiles = fs.readdirSync(versePath)
            .filter(file => { return path.extname(file) == '.json' });
          dataFiles.forEach(dataFile => {
            const dataPath = path.join(versePath, dataFile);
            try {
              const data = fs.readJsonSync(dataPath);
              data.userName = data.userName || "Anonymous";
              checkDataArray.push(data);
            } catch (err) {
              console.log('loadProjectDataByType(projectPath, type) ', projectPath, type);
              console.log('Problem reading json file: ', dataPath);
              reject(err);
            }
          });
        });
      });
    }
    resolve(checkDataArray);
  });
}
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Mon Feb 05 2018 18:29:37 GMT-0800 (PST) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
